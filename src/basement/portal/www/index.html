<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /> <!--bytt til egen css fil-->    
  </head>
  <body>
        <!--Navigasjonsbar på toppen-->
        <nav class="nav-bar">
            <img class="logo-img" src="BasementUB-logo.PNG" alt="Logo" onClick="visAlleKort()"/> <!--Logo skal lenke til forsiden?-->
            <div class="container2" id="filterMeny" onclick="openMenu(this)"> <!--Denne må kunne forbedres-->
                <div class="bar1"></div>  <!--Disse er de svarte barene i menyen, men dette burde kunne forbedres-->
                <div class="bar2"></div>
                <div class="bar3"></div>
                <div class="hamburg-dropdown" id="hamburg-dropdown" style="display:none" onClick='javascript:void(0);'>
                  <h2>Kategorier</h2>
                  <a href="#" onClick="visAlleKort()">Mest populære</a>
                  <a href="#" onClick="visAlleKort()">Nyeste</a>
                  <a href="#" onClick="visAlleKort()">Førstkommende</a>
                  <h2>Sjanger</h2>
                  <a href="" onClick="filtrerKort('Pop')">Pop</a>
                  <a href="" onClick="filtrerKort('Rap')">Rap</a>
                  <a href="" onClick="filtrerKort('Indie')">Indie</a>
                  <a href="" onClick="filtrerKort('Rock')">Rock</a>
                  <a href="" onClick="filtrerKort('Metal')">Metal</a>
                  <a href="" onClick="filtrerKort('Klassisk')">Klassisk</a>
                  <a href="" onClick="filtrerKort('Jazz')">Jazz</a>
                  <a href="" onClick="filtrerKort('Elektro')">Elektronisk</a>
                  <a href="" onClick="filtrerKort('Annet')">Annet</a>
                </div>
            </div><!-- Login-knappen -->
            <button class="login" id="login-btn" onClick="document.getElementById('id01').style.display='block'" style="width:auto;" >Log in/Sign up</button> <!--Knappen skal åpne et innloggingsvindu, ikke sende til ny side-->

            <div class="urs-options" id="usr-opt" style="display:none">
              <button class="usr-link" id="usr-link" onClick="openUsrmenu()" ></button>
              <div id="usr-dropdown" class="usr-dropdown-menu" >
                <a href="#">Profil</a>
                <a href="#" onClick="openEventReg()">Lag konsert</a>
                <a href="#" onClick="logOut()">Logg ut</a>
              </div>
            </div>
            <h1 class="page-title">Basement</h1><!--Font for denne endres i CSS-->
          </nav>
          <!--Dette er innloggingsformen-->
          <div id="id01" class="modal">
            <form id="form1" class="modal-content animate" action="javascript:void(0);" onsubmit="validerLogin(document.getElementById('uname-login'), document.getElementById('psw-login'), document.getElementById('remember').checked)" method="post">
                <div class="imgcontainer"><!--Dette er X-en oppe i hjørnet-->
                    <span onclick="document.getElementById('id01').style.display='none'; clearFields('form1');" class="close" title="Close Modal">&times;</span>
                </div>
                <div class="container"><!--Brukernavn og passord til innlogging:-->
                    <label for="uname"><b>Brukernavn</b></label>
                    <input type="text" placeholder="Skriv Brukernavn" name="uname" id="uname-login" onchange="this.setCustomValidity('')" required />
              
                    <label for="psw"><b>Passord</b></label>
                    <input type="password" placeholder="Skriv Passord" name="psw" id="psw-login" onchange="document.getElementById('uname-login').setCustomValidity('')" required />
                      
                    <button type="submit" onClick="">Logg inn</button>
                    <label>
                      <input type="checkbox" checked="checked" id="remember" /> Husk meg
                    </label>
                  </div>
                  <div class="container" style="background-color:#f1f1f1">
                    <button class="newusr" onClick="openReg()" style="width:auto;">Opprett bruker</button><!--Knapp for å registrere ny bruker-->
                    <span class="psw">Glemt <a href="#">passord?</a></span>
                  </div>
            </form>
          </div>
          <!--Formen for å registrere ny bruker:-->
          <div id="id02" class="modal2">
            <form id="form2" class="modal-content animate" action="javascript:void(0)" onsubmit="regNyBruker(this)" method="post">
                <div class="imgcontainer"><!--Dette er x-en oppe i hjørnet for å lukke vinduet-->
                    <span onclick="document.getElementById('id02').style.display='none'; clearFields('form2')" class="close" title="Close Modal">&times;</span>
                </div>
                <div class="container"><!--Felt for brukernavn:-->
                    <label for="reguname"><b>Brukernavn</b></label>
                    <input type="text" placeholder="Skriv Brukernavn" name="uname" id="uname1" required />
                    <!--Feltene for passord, med mønster som må følges:-->
                    <label for="regpsw1"><b>Passord</b></label>
                    <input type="password" placeholder="Minst 8 karakterer: stor bokstav, liten bokstav, og tegn" name="psw" id="psw1" pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" title="Passordet må inneholde stor bokstav, liten bokstav, tall og være 8 karakterer langt" required />
                    <label for="regpsw2"><b>Bekreft passord</b></label>
                    <input type="password" placeholder="Bekreft Passord" name="psw" id="psw2" oninput="checkPassword(this)" pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" title="Passordet må inneholde stor bokstav, liten bokstav, tall og være 8 karakterer langt" required />
                    <!--Feltene for e-postadresse:-->
                    <label for="mail1"><b>E-post</b></label>
                    <input type="email" placeholder="Angi E-postadresse" name="email" id="email1" required />
                    <label for="mail2"><b>Bekreft e-post</b></label>
                    <input type="email" placeholder="Angi E-postadresse" name="email" id="email2" oninput="checkEmail(this)" required />

                    <label><!--Boks for om brukeren er en artist. Denne vil være automatisk i prototypen-->
                      <input type="checkbox" checked="checked" id="checkArtist" /> Jeg er en artist
                    </label>
                  
                    <button type="submit">Registrer bruker</button>
                    
                  </div>
            </form>
          </div><!--Denne er for å lage et nytt konsertkort-->
          <div id="id03" class="modal3">
            <form id="form3" class="modal-content animate" action="javascript:void(0);" onsubmit="lagKort(this)">
              <div class="imgcontainer"><!--Dette er x-en oppe i hjørnet for å lukke vinduet-->
                <span onclick="document.getElementById('id03').style.display='none'; clearFields('form3')" class="close" title="Close Modal">&times;</span>
            </div>
              <div class="container"><!--Felt for brukernavn:-->
                <label for="bildelink">Lenke til bilde:</label>
                <input type="text" placeholder="Bildelenke" id="bildelink" />
                <label for="datokonsert">Konsertdato</label>
                <input type="date" placeholder="3/3/3" id="konsertdato" required />
                <label for="spillested">Konsertlokale</label>
                <input type="text" placeholder="Sted" id="konsertsted" required />
                <label for="merinfo">Informasjon</label>
                <input type="text" placeholder="Info..." id="merinfo" /> 
                <label for="musikktype">Sjanger</label>
                <select name="sjanger" id="sjanger" required>
                  <option value="Pop">Pop</option>
                  <option value="Rap">Rap</option>
                  <option value="Indie">Indie</option>
                  <option value="Rock">Rock</option>
                  <option value="Metal">Metal</option>
                  <option value="Klassisk">Klassisk</option>
                  <option value="Jazz">Jazz</option>
                  <option value="Elektro">Elektronisk</option>
                  <option value="Annet">Annet</option>
                </select>
                <button type="submit">Registrer konsert</button>
                </div>
            </form>
          </div><!--Denne er for det utvida konsert-kortet -->
          <div id="id04" class="modal4">
            <form id="form4" class="modal-content animate" action="javascript:void(0);">
              <div class="imgcontainer-info" ><!--Dette er x-en oppe i hjørnet for å lukke vinduet-->
                <span id="X-knapp" onclick="document.getElementById('id04').style.display='none';" class="close" title="Close Modal">&times;</span>
                <img src="" id="large-img" />
              </div>
              <div class="container-konsert" style="height:60%">
              
              <p id="exp-sjanger" style="position: absolute; float: left; padding-left: 0.5em;"><b></b></p>
              <h2 style="text-align:center; display:inline-block; position: absolue; margin-top: 0; margin-bottom: 0;" id="artistname"></h2>
              <p id="tidogsted"></p>
              <textarea readonly rows="10" style="width:90%; margin-bottom: 1em;" id="infoarea"></textarea>
              <button name="sletteKnapp" id="sletteKnapp" data-id="" onclick="slettKort()" style="display:none">Slett konsert</button>
            </div>
            </form>
          </div>
          <!--Her skal feeden for poster være-->
          <div class="row" id="row">

          </div>
    </body>
    <footer>
    </footer>
    <script>
        //Hent Modalen
        var modal = document.getElementById('id01');
        var modal2 = document.getElementById('id02');
        var modal3 = document.getElementById('id03');
        const baseURL = "https://api.basement.yoga.unicus.com/v0/";
        var xhr;
        
        //Henter elementer når siden lastes inn
        window.onload = function(){
          hentKort();
          var kort = document.getElementById('row').getElementsByClassName('column');
          for(var i=0;i<kort.length; i++){
            if(sessionStorage.getItem((kort[i].getAttribute(('id')) + '-visible')) == 'none'){
              kort[i].style.display = 'none';
            }else{
              kort[i].style.display = 'block';
            }
          }
          sjekkLogin();
        }
        //Henter alle kortene som skal vises på siden
        function hentKort(){
          xhr = new XMLHttpRequest();
          var url = baseURL + "card/list?page=0&limit=12";
          xhr.open("GET", url, true);
          xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
          xhr.withCredentials = true;
          var sjanger = sessionStorage.getItem('filter');
          xhr.onload = function() {
            if(xhr.status == 200){
              console.log(JSON.parse(xhr.responseText));
              var arrayOfThings = JSON.parse(xhr.responseText);
              for(var i=0;i<arrayOfThings.length;i++){
                var ooobject = arrayOfThings[i];
                
                if(!sjanger || ooobject.genre == sjanger){
                  var column = fillColumn(ooobject);
                  var row = document.getElementById('row');
                  row.appendChild(column);
                }
                
              }
            }else{
              console.log(xhr.responseText);
            }
          };
          xhr.onerror = function() {
            console.log('There was an error!');
          }
          xhr.send();
        }
        //Setter cookie for innlogging
        function setCookie(brukernavn, dato){
          let name = "basement";
          let uname = encodeURIComponent(brukernavn);
          let utgaar = "";
          if(dato){
            var date = new Date();
            date.setDate(date.getDate() + 365);
            utgaar = "; expires=" + date.toUTCString();
          }
          document.cookie = name + "=" + uname + utgaar;
        }
        //Henter cookie for innlogging
        function getCookie(){
          var cooookies = document.cookie.split(';');
          for (var i = 0; i < cooookies.length; i++) {
            var name = cooookies[i].split('=')[0];
            var value = cooookies[i].split('=')[1];
            if(name == ' basement'){
              return decodeURIComponent(value);
            }
          }
          return "";
        }
        //Fjerner cookie for utlogging
        function deleteCookie(){
          document.cookie = "basement=; expires=Fri, 2 Jan 1970 12:00:00 UTC;";
        }

        

        //Sjekker om brukeren er innlogget eller ikke
        function sjekkLogin(){
          var inne = getCookie();
          if(!inne){
            document.getElementById('login-btn').style.display = "block";
            document.getElementById('usr-opt').style.display = "none";
          }else{
            sessionStorage.setItem('userName', inne)
            document.getElementById('usr-link').innerHTML = inne;
            document.getElementById('login-btn').style.display = "none";
            document.getElementById('usr-opt').style.display = "block";
          }
        }
        //Funksjon for å logge ut
        function logOut(){
          sessionStorage.removeItem('userName');
          sessionStorage.removeItem('filter');
          deleteCookie();
          window.location.reload();
        }
        
        //Funksjon for å åpne nedtrekksmeny under brukernavn
        function openUsrmenu(){
          document.getElementById("usr-dropdown").classList.toggle("show");
        }

        //Når noen trykker utenfor vinduet, lukk det
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
                clearFields("form1");
            }
            if (event.target == modal3) {
                modal3.style.display = "none";
                clearFields("form3");
            }
            if (!event.target.matches('.usr-link')) {
              var dropdowns = document.getElementsByClassName("usr-dropdown-menu");
              var i;
              for (i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                  openDropdown.classList.remove('show');
                }
              }
            }
        }
        //Tømmer alle feltene når registrerings- eller innloggingsvinduet lukkes
        function clearFields(myform){
          document.getElementById(myform).reset();
        }
        //Åpner registreringsvinduet og lukker innloggingsvinduet
        function openReg(){
          document.getElementById('id02').style.display='block';
          modal.style.display = "none";
        }
        //Åpner vinduet for å registrere nytt arrangement
        function openEventReg(){
          document.getElementById('id03').style.display='block';
        }

        //Sjekker at passordene matcher
        function checkPassword(input){
          if(input.value != document.getElementById('psw1').value){
            input.setCustomValidity('Passordet matcher ikke.');
          }else{
            input.setCustomValidity('');
          }
        }
        //Sjekker at e-postene matcher 
        function checkEmail(input){
          if(input.value != document.getElementById('email1').value){
            input.setCustomValidity('E-postadressen matcher ikke.');
          }else{
            input.setCustomValidity('');
          }
        }
        //Denne bare sjekker at innloggingen er riktig 
        function validerLogin(user_name, pass_word, bli_inne){
          xhr = new XMLHttpRequest();
          var url = baseURL + "user/login";
          xhr.open("POST", url, true);
          xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
          xhr.withCredentials = true;
          var data = "username=" + user_name.value + "&password=" + pass_word.value;
          xhr.onload = function() {
            var responseText = xhr.responseText;
            if(xhr.status == 204){
              setCookie(user_name.value, bli_inne);
              window.location.reload();
            }else if(xhr.status == 403){
              user_name.setCustomValidity('Brukernavn og passord matcher ikke');
            }else{
              console.log(responseText);
            }
          };
          xhr.onerror = function() {
            console.log('There was an error!');
          };
          xhr.send(data);
        }

        //Dette er funksjonen for å filtrere kortene på forsiden.
        function filtrerKort(input){ 
          sessionStorage.setItem('filter', input);
          hentKort();
        }

        //Denne funksjonen setter saa alle kort hentes
        function visAlleKort(){
          sessionStorage.setItem('filter', '');
          window.location.reload();
        }
        //Funksjon for å registrere ny bruker
        function regNyBruker(user){
          var userNm = document.getElementById('uname1').value;
          userNm.setCustomValidity('');
          var psWrd1 = document.getElementById('psw1').value;
          var psWrd2 = document.getElementById('psw2').value;
          var eMail = document.getElementById('email1').value;
          xhr = new XMLHttpRequest();
          var url = baseURL + "user/register";
          xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
          xhr.withCredentials = true;
          var data = "username=" + userNm + "&password_one=" + psWrd1 + "&password_two=" + psWrd2 + "&email_address=" + eMail;
          xhr.onload = function() {
            var responseText = xhr.responseText;
            if(xhr.status == 201){
              window.location.reload();
            }else if(xhr.status == 403){
              userNm.setCustomValidity('Brukernavnet er allerede tatt');
            }else{
              console.log(responseText);
            }
          };
          xhr.onerror = function() {
            console.log("There was an error");
          };
          xhr.send(data);        
          
          window.location.reload();
        }
        //Funksjon for å lage et nytt kort/arrangement
        function lagKort(myform){
          xhr = new XMLHttpRequest();
          var url = baseURL + "/card/create";
          var dateNew = document.getElementById('konsertdato').value + "T16:00:00Z";
          xhr.open("POST", url, true);
          xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
          xhr.withCredentials = true;
          xhr.onload = function() {
            if(xhr.status == 201){
              sessionStorage.setItem('filter', '');
              hentKort();
            }else{
              console.log(xhr.responseText);
            }
          };
          xhr.onerror = function() {
            console.log("There was an error");
          };
          var data = JSON.stringify({"title":sessionStorage.getItem('userName'), "genre":document.getElementById('sjanger').value, "description":document.getElementById('merinfo').value, "date":dateNew, "location":document.getElementById('konsertsted').value, "image_url":document.getElementById('bildelink').value});
          xhr.send(data);
          modal3.style.display = "none";
          clearFields("form3");
        }
        //Denne trenger ikke forandring
        function fillColumn(responsJson){
          var column = document.createElement('div');
          var card = document.createElement('div');
          var dato = responsJson.date.split('T');

          column.setAttribute("class", "column");
          column.setAttribute("data-genre", responsJson.genre);
          column.setAttribute("id", responsJson.id);
          
          card.setAttribute("class", "card");
          card.setAttribute("data-genre", responsJson.genre);
          card.setAttribute("data-img", responsJson.image_url);
          card.setAttribute("data-artist", responsJson.title);
          card.setAttribute("data-dato", dato[0]);
          card.setAttribute("data-sted", responsJson.location);
          card.setAttribute("data-info", responsJson.description);
          card.setAttribute("onClick", "openCard(this)");
          var cardBody = '"><h3>' + responsJson.title + '</h3><p>' + dato[0] + ' - ' + responsJson.location + '</p><p>' + responsJson.genre + '</p>';
          if(responsJson.img == ''){
            card.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/5/50/Black_colour.jpg' + cardBody;
          }else{
            card.innerHTML = '<img src="' + responsJson.image_url + cardBody;
          }
          column.appendChild(card);
          return column;
        }

        //Funksjon for å få større utgave av arrangementet
        function openCard(input){
          document.getElementById('exp-sjanger').innerHTML = '' + input.dataset.genre;
          if(input.dataset.img == ''){
            document.getElementById('large-img').setAttribute("src", "https://upload.wikimedia.org/wikipedia/commons/5/50/Black_colour.jpg");
            document.getElementById('X-knapp').style.color = "white";
          }else{
            document.getElementById('large-img').setAttribute("src", input.dataset.img);
            document.getElementById('X-knapp').style.color = "black";
          }
          document.getElementById('artistname').innerHTML = input.dataset.artist;
          document.getElementById('tidogsted').innerHTML = input.dataset.dato + ' - ' + input.dataset.sted;
          document.getElementById('infoarea').innerHTML = input.dataset.info;
          document.getElementById('sletteKnapp').setAttribute('data-id', input.parentElement.id);
          let kortEier = getCookie();
          if(kortEier && input.dataset.artist == kortEier){
            document.getElementById('sletteKnapp').style.display = 'block';
          }else{
            document.getElementById('sletteKnapp').style.display = 'none';
          }
          document.getElementById('id04').style.display = 'block';
        }
        //Funksjon som sletter kort/konsert
        function slettKort(){
          var kort_id = document.getElementById('sletteKnapp').dataset.id;
          var url = baseURL + "card/" + kort_id + "/delete"
          xhr.open("GET", url, true);
          xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
          xhr.withCredentials = true;
          xhr.onload = function() {
            if(xhr.status == 204){
              window.location.reload();
            }else{
              console.log(xhr.responseText);
            }
          };
          xhr.onerror = function() {
            console.log("Error");
          };
          xhr.send(null);
        }
        
        
        //Åpner menyen i hjørnet
        function openMenu(x) {
            x.classList.toggle("change");
            if(document.getElementById('hamburg-dropdown').style.display == 'none'){
              document.getElementById('hamburg-dropdown').style.display='block';
            }else{
              document.getElementById('hamburg-dropdown').style.display='none';
            }
        }
        //Bare gjør at det å trykke i filter-menyen ikke lukker den
        var filterMeny = document.getElementById('hamburg-dropdown');
        filterMeny.addEventListener("click", function (e) {
          e.stopPropagation()
        });

    </script>

</html>